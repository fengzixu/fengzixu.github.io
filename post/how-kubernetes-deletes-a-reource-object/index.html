<!DOCTYPE html>
<html lang="en" data-figures="" class="page">
  <head>  <title>How Kubernetes Deletes A Pod Gracefully | Littledriver&#39;s Blog</title>
  <meta charset='utf-8'>
  <meta name="generator" content="Hugo 0.74.3" />
  <meta name = 'viewport' content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
  <meta http-equiv = 'X-UA-Compatible' content = 'IE=edge'>
<script async src="https://www.googletagmanager.com/gtag/js?id=XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'XXXXXXXXXX');
</script>
<meta property = "og:locale" content = "en_US" />
<meta property="og:type" content="article">
<meta name="description" content="This blog will introduct the graceful deletion proceess of pod in source code level. It maybe little bit complicated. If you just want to know the process in …">
<meta name = "twitter:card" content = "summary_large_image" />
<meta name = "twitter:creator" content = "@Haier0715">
<meta name = "twitter:title" content = "How Kubernetes Deletes A Pod Gracefully" />
<meta property = "og:url" content = "https://littledriver.net/post/how-kubernetes-deletes-a-reource-object/" />
<meta property = "og:title" content = "How Kubernetes Deletes A Pod Gracefully" />
<meta property = "og:description" content = "This blog will introduct the graceful deletion proceess of pod in source code level. It maybe little bit complicated. If you just want to know the process in …" />
<meta property = "og:image" content = "https://littledriver.net/images/thumbnail.png" />
<link rel='apple-touch-icon' sizes='180x180' href='https://littledriver.net/icons/apple-touch-icon.png'>
<link rel='icon' type='image/png' sizes='32x32' href='https://littledriver.net/icons/favicon-32x32.png'>
<link rel='icon' type='image/png' sizes='16x16' href='https://littledriver.net/icons/favicon-16x16.png'>
<link rel='manifest' href='https://littledriver.net/icons/site.webmanifest'>
<link rel="mask-icon" href= 'https://littledriver.net/safari-pinned-tab.svg' color="#002538">
<meta name="msapplication-TileColor" content="#002538">
<meta name="theme-color" content="#002538">

  <link rel='canonical' href='https://littledriver.net/post/how-kubernetes-deletes-a-reource-object/'>

    

    
    <link rel="preload" href="https://littledriver.net/css/styles.911db35c8e306d717b4098e7a4f14096bbc15388e4c04e8b7e7809a9d1dd2820d178edba6928d1cbfa82083bd2263626853f300038e96a7dc6284ace1dfdcdc9.css" integrity = 'sha512-kR2zXI4wbXF7QJjnpPFAlrvBU4jkwE6LfngJqdHdKCDReO26aSjRy/qCCDvSJjYmhT8wADjpan3GKErOHf3NyQ==' as="style">
    <link rel="preload" href="https://littledriver.net/js/bundle.7931a7d4f76c078f1d802a6fb248ded50ab9cdad3afc0715215a9e6aae99cb3e041795cd26bee78992949e322a724772f97789f849656869980be6b0d540eed8.js" as="script">

    
    <link rel = 'stylesheet' href = 'https://littledriver.net/css/styles.911db35c8e306d717b4098e7a4f14096bbc15388e4c04e8b7e7809a9d1dd2820d178edba6928d1cbfa82083bd2263626853f300038e96a7dc6284ace1dfdcdc9.css' integrity = 'sha512-kR2zXI4wbXF7QJjnpPFAlrvBU4jkwE6LfngJqdHdKCDReO26aSjRy/qCCDvSJjYmhT8wADjpan3GKErOHf3NyQ=='>
	  
  </head>
  
  
    
  
  <body data-code="7" data-lines="false" id="documentTop">

<header class = 'nav_header' >
  <nav class = 'nav'>
    <a href='https://littledriver.net/' class = 'nav_brand nav_item'>
        Littledriver&#39;s Blog
      <div class = 'nav_close'>
        <svg class="icon">
          <use xlink:href="#open-menu"></use>
        </svg>
        <svg class="icon">
          <use xlink:href="#closeme"></use>
        </svg>
      </div>
    </a>
    <div class = 'nav_body nav_body_left'>
      <div class = 'nav_parent'>
        <a href = 'https://littledriver.net/' class = 'nav_item'>Home </a>
      </div>
      <div class = 'nav_parent'>
        <a href = 'https://littledriver.net/about/' class = 'nav_item'>About </a>
      </div>
<div class='follow'>
  <a href='https://github.com/fengzixu'>
    <svg class="icon">
      <use xlink:href="#github"></use>
    </svg>
  </a>
  <a href='https://twitter.com/@Haier0715'>
    <svg class="icon">
      <use xlink:href="#twitter"></use>
    </svg>
  </a>
  
  <a href='https://littledriver.net/index.xml'>
    <svg class="icon">
      <use xlink:href="#rss"></use>
    </svg>
  </a>
<div class = 'color_mode'>
  <input type = 'checkbox' class = 'color_choice' id = 'mode'>
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class = 'grid-inverse wrap content'>
  <article class='post_content'>
    <h1 class='post_title'>How Kubernetes Deletes A Pod Gracefully</h1><div class = 'post_meta'>
  <svg class="icon">
    <use xlink:href="#calendar"></use>
  </svg>
  <span class="post_date">
    Aug 15, 2020</span>
  <a href = 'https://littledriver.net/tags/kuberentes' class = 'post_tag button button_translucent'>kuberentes
  </a>
</div>

    <div class='post_share'>
  Share on:
  <a href="https://twitter.com/intent/tweet?text=How%20Kubernetes%20Deletes%20A%20Pod%20Gracefully&url=https%3a%2f%2flittledriver.net%2fpost%2fhow-kubernetes-deletes-a-reource-object%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
    <svg class="icon">
      <use xlink:href="#twitter"></use>
    </svg>
  </a>
  
  <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2flittledriver.net%2fpost%2fhow-kubernetes-deletes-a-reource-object%2f&t=How%20Kubernetes%20Deletes%20A%20Pod%20Gracefully" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
    <svg class="icon">
      <use xlink:href="#facebook"></use>
    </svg>
  </a>
  <script>
    function shareViaLinkedin() {
      window.open('http://www.linkedin.com/shareArticle?mini=true&url='+encodeURIComponent("https://littledriver.net/post/how-kubernetes-deletes-a-reource-object/"), '', 'left=0,top=0,width=650,height=420,personalbar=0,toolbar=0,scrollbars=0,resizable=0');
    }
  </script>
  <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow" onclick="shareViaLinkedin()">
    <svg class="icon">
      <use xlink:href="#linkedin"></use>
    </svg>
  </a>
  <a href="https://littledriver.net/post/how-kubernetes-deletes-a-reource-object/" title="Copy Link" class="link link_yank">
    <svg class="icon">
      <use xlink:href="#yank"></use>
    </svg>
  </a>
</div>

    
    
    <h2>Overview</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#hey-my-pod-was-stuck-in-terminating-state">Hey! My pod was stuck in Terminating state</a></li>
    <li><a href="#the-deletion-process">The deletion process</a>
      <ul>
        <li><a href="#first-round----from-deletion-request-to-kube-apiserver">First Round &ndash; from deletion request to kube-apiserver</a></li>
        <li><a href="#second-round----from-kubelet-to-kube-apiserver">Second Round &ndash; from kubelet to kube-apiserver</a></li>
        <li><a href="#third-round----from-kube-apiserver-to-etcd">Third Round &ndash; from kube-apiserver to etcd</a></li>
      </ul>
    </li>
    <li><a href="#about-finalizers">About Finalizers</a></li>
    <li><a href="#which-reasons-can-cause-the-deletion-process-was-stuck">Which reasons can cause the deletion process was stuck</a></li>
    <li><a href="#about-force-deletion">About Force Deletion</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
    <blockquote>
<p>This blog will introduct the graceful deletion proceess of pod in source code level. It maybe little bit complicated. If you just want to know the process in high level, you can reference the <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination">official document</a></p>
</blockquote>
<h2 id="hey-my-pod-was-stuck-in-terminating-state">Hey! My pod was stuck in Terminating state</h2>
<p>During my on-call time, some users ask for my help with their pods that cannot be deleted successfully in the Kubernetes cluster. Maybe the pod was stuck in the <code>Terminating</code> state, maybe &ldquo;kubectl delete <!-- raw HTML omitted -->&rdquo; has been returned, but that pod object still exists.</p>
<p>But, the user doesn&rsquo;t always give me a chance to fix it. A &ldquo;popular&rdquo; workaround on the Internet tells them &ldquo;kubectl delete <!-- raw HTML omitted --> &ndash;force &ndash;grace-period=0&rdquo; can help them. Actually, &ldquo;force delete&rdquo; is a kind of dangerous behavior if you didn&rsquo;t know what&rsquo;s a consequence. It may cause the data inconsistency in the Kubernetes cluster. It also breaks the troubling scenario so that we may lose the chance to find an implicit and important issue.</p>
<p>The best approach to troubleshoot this problem is to know the expected deletion behavior first and compare it with the actual behavior, and then fix the difference. So, I want to introduce the graceful deletion process of Kubernetes and related working mechanism on this blog. I hope it can help you to troubleshoot this kind of issue.</p>
<h2 id="the-deletion-process">The deletion process</h2>
<p>When you sent a request of deleting a pod object to kube-apiserver component by RESTful API or kubectl command, it was handled by <code>StandardStorage</code> of kube-apiserver first. Because the primary responsibility of kube-apiserver is to maintain resource data on the etcd cluster, other components like kube-controller-manager and kube-scheduler just watch data changes and move them from the actual state to the desired state.</p>
<p>Here is a <code>Store</code> package in kube-apiserver repo; it implemented all methods of <a href="https://sourcegraph.com/github.com/kubernetes/kubernetes@v1.14.6/-/blob/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L866">StandardStorage</a>. The <code>Delete</code> function is called.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="c1">// Delete removes the item from storage.
</span><span class="ln">2</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="o">...</span>
<span class="ln">4</span>    <span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">5</span>    <span class="o">...</span>
</code></pre></div><h3 id="first-round----from-deletion-request-to-kube-apiserver">First Round &ndash; from deletion request to kube-apiserver</h3>
<p>In <code>rest.BeforeDelete</code> function, it invokes <code>CheckGracefulDelete</code> method to confirm if the resource you want to delete needs to be deleted gracefully or not. Actually, any resource can implement their graceful deletion logic by <code>RESTGracefulDeleteStrategy</code> interface. Now, only native kubernetes Pod resource is supported.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">strategy</span> <span class="nx">RESTDeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">graceful</span><span class="p">,</span> <span class="nx">gracefulPending</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>	<span class="nx">gracefulStrategy</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">strategy</span><span class="p">.(</span><span class="nx">RESTGracefulDeleteStrategy</span><span class="p">)</span>
<span class="ln"> 4</span>	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
<span class="ln"> 5</span>		<span class="c1">// If we&#39;re not deleting gracefully there&#39;s no point in updating Generation, as we won&#39;t update
</span><span class="ln"> 6</span><span class="c1"></span>		<span class="c1">// the obcject before deleting it.
</span><span class="ln"> 7</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
<span class="ln"> 8</span>	<span class="p">}</span>
<span class="ln"> 9</span>	<span class="c1">// if the object is already being deleted, no need to update generation.
</span><span class="ln">10</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">objectMeta</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">11</span>        <span class="o">...</span>
<span class="ln">12</span>	<span class="p">}</span>
<span class="ln">13</span>
<span class="ln">14</span>	<span class="k">if</span> <span class="p">!</span><span class="nx">gracefulStrategy</span><span class="p">.</span><span class="nf">CheckGracefulDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>        
<span class="ln">16</span>       <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>    <span class="o">...</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p>In the <code>CheckGracefulDelete</code> function, it tries to calculate the graceful deletion period by different approaches. Those approaches can be divided into three types</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="c1">// RESTGracefulDeleteStrategy must be implemented by the registry that supports
</span><span class="ln"> 2</span><span class="c1">// graceful deletion.
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">type</span> <span class="nx">RESTGracefulDeleteStrategy</span> <span class="kd">interface</span> <span class="p">{</span>
<span class="ln"> 4</span>	<span class="c1">// CheckGracefulDelete should return true if the object can be gracefully deleted and set
</span><span class="ln"> 5</span><span class="c1"></span>	<span class="c1">// any default values on the DeleteOptions.
</span><span class="ln"> 6</span><span class="c1"></span>	<span class="nf">CheckGracefulDelete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">bool</span>
<span class="ln"> 7</span><span class="p">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="c1">// CheckGracefulDelete allows a pod to be gracefully deleted. It updates the DeleteOptions to
</span><span class="ln">10</span><span class="c1">// reflect the desired grace value.
</span><span class="ln">11</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">podStrategy</span><span class="p">)</span> <span class="nf">CheckGracefulDelete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
<span class="ln">12</span>	<span class="k">if</span> <span class="nx">options</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">13</span>		<span class="k">return</span> <span class="kc">false</span>
<span class="ln">14</span>	<span class="p">}</span>
<span class="ln">15</span>	<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span>
<span class="ln">16</span>	<span class="nx">period</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">17</span>	<span class="c1">// user has specified a value
</span><span class="ln">18</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">19</span>		<span class="nx">period</span> <span class="p">=</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span>
<span class="ln">20</span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">21</span>		<span class="c1">// use the default value if set, or deletes the pod immediately (0)
</span><span class="ln">22</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">23</span>			<span class="nx">period</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
<span class="ln">24</span>		<span class="p">}</span>
<span class="ln">25</span>	<span class="p">}</span>
<span class="ln">26</span>	<span class="c1">// if the pod is not scheduled, delete immediately
</span><span class="ln">27</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">28</span>		<span class="nx">period</span> <span class="p">=</span> <span class="mi">0</span>
<span class="ln">29</span>	<span class="p">}</span>
<span class="ln">30</span>	<span class="c1">// if the pod is already terminated, delete immediately
</span><span class="ln">31</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">==</span> <span class="nx">api</span><span class="p">.</span><span class="nx">PodFailed</span> <span class="o">||</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">==</span> <span class="nx">api</span><span class="p">.</span><span class="nx">PodSucceeded</span> <span class="p">{</span>
<span class="ln">32</span>		<span class="nx">period</span> <span class="p">=</span> <span class="mi">0</span>
<span class="ln">33</span>	<span class="p">}</span>
<span class="ln">34</span>	<span class="c1">// ensure the options and the pod are in sync
</span><span class="ln">35</span><span class="c1"></span>	<span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">period</span>
<span class="ln">36</span>	<span class="k">return</span> <span class="kc">true</span>
<span class="ln">37</span><span class="p">}</span>
</code></pre></div><h4 id="running-pod">Running Pod</h4>
<p>It picks up the <code>GracePeriodSeconds</code> of DeleteOptions first. You can specify it by command argument of kubectl or api request. For example, &ldquo;kubectl delete <!-- raw HTML omitted --> &ndash;grace-period=10&rdquo;, the <code>GracePeriodSeconds</code> should be 30 seconds by default. If you didn&rsquo;t specify it, <code>pod.Spec.TerminationGracePeriodSeconds</code> will be used.</p>
<h4 id="pending-pod">Pending Pod</h4>
<p>The only thing of kube-scheduler did for every pod is update <code>scheduable node name</code> to <code>pod.Spec.NodeName</code>, so that kubelet on that host can run the pod. So, if <code>pod.Spec.NodeName</code> is nil, it means pod doesn&rsquo;t run. It must be fine to delete it at once ( 0 graceful period means delete at once)</p>
<h4 id="terminated-pod">Terminated Pod</h4>
<p>For <code>Terminated Pod</code>, it was almost the same as <code>Pending Pod</code> because they are not running.</p>
<p>After the graceful deletion period was confirmed, kube-apiserver will set <code>DeletionTimestamp</code> and <code>DeletionGracePeriodSeconds</code> for the pod.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">strategy</span> <span class="nx">RESTDeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">graceful</span><span class="p">,</span> <span class="nx">gracefulPending</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="o">...</span><span class="p">.</span>
<span class="ln"> 3</span>	<span class="k">if</span> <span class="p">!</span><span class="nx">gracefulStrategy</span><span class="p">.</span><span class="nf">CheckGracefulDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>        
<span class="ln"> 5</span>       <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>    <span class="o">...</span>
<span class="ln"> 8</span>	<span class="nx">now</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewTime</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span><span class="p">)))</span>
<span class="ln"> 9</span>	<span class="nx">objectMeta</span><span class="p">.</span><span class="nf">SetDeletionTimestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">now</span><span class="p">)</span>
<span class="ln">10</span>    <span class="nx">objectMeta</span><span class="p">.</span><span class="nf">SetDeletionGracePeriodSeconds</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span><span class="p">)</span>
<span class="ln">11</span>    <span class="o">...</span>
<span class="ln">12</span>	<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
</code></pre></div><p>kube-apiserver will update <code>DeletionTimestamp</code> and <code>DeletionGracePeriodSeconds</code> to the pod by <code>updateForGracefulDeletionAndFinalizers</code> function</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln">1</span><span class="c1">// Delete removes the item from storage.
</span><span class="ln">2</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="o">...</span>
<span class="ln">4</span>    <span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">5</span>    <span class="o">...</span>
<span class="ln">6</span>    <span class="k">if</span> <span class="nx">graceful</span> <span class="o">||</span> <span class="nx">pendingFinalizers</span> <span class="o">||</span> <span class="nx">shouldUpdateFinalizers</span> <span class="p">{</span>
<span class="ln">7</span>		<span class="nx">err</span><span class="p">,</span> <span class="nx">ignoreNotFound</span><span class="p">,</span> <span class="nx">deleteImmediately</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">updateForGracefulDeletionAndFinalizers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">preconditions</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="ln">8</span>	<span class="p">}</span>
</code></pre></div><p>In <code>updateForGracefulDeletionAndFinalizers</code> function, kube-apiserver not only updates <code>DeletionTimestamp</code> based on graceful deletion time, but also update finalizers to the pod if it found some new finalizers.</p>
<p><code>finalizer</code> is another important concept when a resource object was deleted. It was related to the Gargabe Collector ,cascade-deletion, and ownerReference. If a resource object supports cascade-deletion, it must implement <code>GarbageCollectionDeleteStrategy</code> interfaces. Now, you can understand it as a set of <code>pre-delete</code> hooks. They are performed one by one and removed after it was finished.</p>
<p>According to the logic of <code>updateForGracefulDeletionAndFinalizers</code>, you may know the deletion of the pod was controlled by two guys.</p>
<ol>
<li>finalizers</li>
<li>graceful time</li>
</ol>
<p>Both of them need the resource object implement <code>GarbageCollectionDeleteStrategy</code> and <code>RESTGracefulDeleteStrategy</code> interfaces. <em>Only finalizers is nil and graceful time is 0</em>, that pod can be deleted from the storage successfully. Otherwise it will be blocked.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">updateForGracefulDeletionAndFinalizers</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">,</span> <span class="nx">preconditions</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">Preconditions</span><span class="p">,</span> <span class="nx">in</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">ignoreNotFound</span><span class="p">,</span> <span class="nx">deleteImmediately</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="nx">lastGraceful</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="ln"> 3</span>	<span class="kd">var</span> <span class="nx">pendingFinalizers</span> <span class="kt">bool</span>
<span class="ln"> 4</span>	<span class="nx">out</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewFunc</span><span class="p">()</span>
<span class="ln"> 5</span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">GuaranteedUpdate</span><span class="p">(</span>
<span class="ln"> 6</span>		<span class="nx">ctx</span><span class="p">,</span>
<span class="ln"> 7</span>		<span class="nx">key</span><span class="p">,</span>
<span class="ln"> 8</span>		<span class="nx">out</span><span class="p">,</span>
<span class="ln"> 9</span>		<span class="kc">false</span><span class="p">,</span> <span class="cm">/* ignoreNotFound */</span>
<span class="ln">10</span>		<span class="o">&amp;</span><span class="nx">preconditions</span><span class="p">,</span>
<span class="ln">11</span>		<span class="nx">storage</span><span class="p">.</span><span class="nf">SimpleUpdate</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">existing</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>			<span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">existing</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">13</span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">15</span>			<span class="p">}</span>
<span class="ln">16</span>			<span class="k">if</span> <span class="nx">pendingGraceful</span> <span class="p">{</span>
<span class="ln">17</span>				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errAlreadyDeleting</span>
<span class="ln">18</span>			<span class="p">}</span>
<span class="ln">19</span>
<span class="ln">20</span>			<span class="c1">// Add/remove the orphan finalizer as the options dictates.
</span><span class="ln">21</span><span class="c1"></span>			<span class="c1">// Note that this occurs after checking pendingGraceufl, so
</span><span class="ln">22</span><span class="c1"></span>			<span class="c1">// finalizers cannot be updated via DeleteOptions if deletion has
</span><span class="ln">23</span><span class="c1"></span>			<span class="c1">// started.
</span><span class="ln">24</span><span class="c1"></span>			<span class="nx">existingAccessor</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">Accessor</span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span>
<span class="ln">25</span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">26</span>				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">27</span>			<span class="p">}</span>
<span class="ln">28</span>			<span class="nx">needsUpdate</span><span class="p">,</span> <span class="nx">newFinalizers</span> <span class="o">:=</span> <span class="nf">deletionFinalizersForGarbageCollection</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">existingAccessor</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln">29</span>			<span class="k">if</span> <span class="nx">needsUpdate</span> <span class="p">{</span>
<span class="ln">30</span>				<span class="nx">existingAccessor</span><span class="p">.</span><span class="nf">SetFinalizers</span><span class="p">(</span><span class="nx">newFinalizers</span><span class="p">)</span>
<span class="ln">31</span>			<span class="p">}</span>
<span class="ln">32</span>
<span class="ln">33</span>			<span class="nx">lastGraceful</span> <span class="p">=</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span>
<span class="ln">34</span>			<span class="nx">lastExisting</span> <span class="p">=</span> <span class="nx">existing</span>
<span class="ln">35</span>			<span class="k">return</span> <span class="nx">existing</span><span class="p">,</span> <span class="kc">nil</span>
<span class="ln">36</span>		<span class="p">}),</span>
<span class="ln">37</span>		<span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">),</span>
<span class="ln">38</span>	<span class="p">)</span>
<span class="ln">39</span>	<span class="k">switch</span> <span class="nx">err</span> <span class="p">{</span>
<span class="ln">40</span>	<span class="k">case</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln">41</span>		<span class="c1">// If there are pending finalizers, we never delete the object immediately.
</span><span class="ln">42</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">pendingFinalizers</span> <span class="p">{</span>
<span class="ln">43</span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span>
<span class="ln">44</span>		<span class="p">}</span>
<span class="ln">45</span>		<span class="k">if</span> <span class="nx">lastGraceful</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
<span class="ln">46</span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span>
<span class="ln">47</span>        <span class="p">}</span>
<span class="ln">48</span>        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span>
<span class="ln">49</span>        <span class="o">...</span>
<span class="ln">50</span><span class="p">}</span>
</code></pre></div><p>After kube-apiserver updated <code>DeletionTimestamp</code> of pod, <code>deleteImmediately</code> was returned as false. The first round of the deletion pod was finished. In the next round, kubelet will be a leader.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="c1">// Delete removes the item from storage.
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>	<span class="o">...</span>
<span class="ln"> 4</span>	<span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln"> 5</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 6</span>		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln"> 7</span>	<span class="p">}</span>
<span class="ln"> 8</span>    <span class="o">...</span><span class="p">.</span>
<span class="ln"> 9</span>	<span class="k">if</span> <span class="nx">graceful</span> <span class="o">||</span> <span class="nx">pendingFinalizers</span> <span class="o">||</span> <span class="nx">shouldUpdateFinalizers</span> <span class="p">{</span>
<span class="ln">10</span>		<span class="nx">err</span><span class="p">,</span> <span class="nx">ignoreNotFound</span><span class="p">,</span> <span class="nx">deleteImmediately</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">updateForGracefulDeletionAndFinalizers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">preconditions</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="ln">11</span>	<span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>	<span class="c1">// !deleteImmediately covers all cases where err != nil. We keep both to be future-proof.
</span><span class="ln">14</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">deleteImmediately</span> <span class="o">||</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">15</span>		<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="o">...</span>
</code></pre></div><h3 id="second-round----from-kubelet-to-kube-apiserver">Second Round &ndash; from kubelet to kube-apiserver</h3>
<p>First of all, you need to know. There is a function called <a href="https://sourcegraph.com/github.com/kubernetes/kubernetes@633ab1c/-/blob/pkg/kubelet/kubelet.go#L1726">syncLoop</a> in the main loop of kubelet. It watched resource changes from multiple places. The most commonplace is kube-apiserver. It will do some reconcile works based on those changes.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncLoop</span><span class="p">(</span><span class="nx">updates</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">PodUpdate</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SyncHandler</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting kubelet main sync loop.&#34;</span><span class="p">)</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>	<span class="k">for</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="o">...</span>
<span class="ln"> 6</span>		<span class="nx">kl</span><span class="p">.</span><span class="nx">syncLoopMonitor</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">kl</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span>
<span class="ln"> 7</span>		<span class="k">if</span> <span class="p">!</span><span class="nx">kl</span><span class="p">.</span><span class="nf">syncLoopIteration</span><span class="p">(</span><span class="nx">updates</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">syncTicker</span><span class="p">.</span><span class="nx">C</span><span class="p">,</span> <span class="nx">housekeepingTicker</span><span class="p">.</span><span class="nx">C</span><span class="p">,</span> <span class="nx">plegCh</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>			<span class="k">break</span>
<span class="ln"> 9</span>		<span class="p">}</span>
<span class="ln">10</span>		<span class="nx">kl</span><span class="p">.</span><span class="nx">syncLoopMonitor</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">kl</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span>
<span class="ln">11</span>	<span class="p">}</span>
<span class="ln">12</span><span class="p">}</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncLoopIteration</span><span class="p">(</span><span class="nx">configCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">PodUpdate</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SyncHandler</span><span class="p">,</span>
<span class="ln">15</span>	<span class="nx">syncCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">housekeepingCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">plegCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">pleg</span><span class="p">.</span><span class="nx">PodLifecycleEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
<span class="ln">16</span>	<span class="k">select</span> <span class="p">{</span>
<span class="ln">17</span>	<span class="k">case</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">open</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">configCh</span><span class="p">:</span>
<span class="ln">18</span>		<span class="k">if</span> <span class="p">!</span><span class="nx">open</span> <span class="p">{</span>
<span class="ln">19</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Update channel is closed. Exiting the sync loop.&#34;</span><span class="p">)</span>
<span class="ln">20</span>			<span class="k">return</span> <span class="kc">false</span>
<span class="ln">21</span>		<span class="p">}</span>
<span class="ln">22</span>
<span class="ln">23</span>		<span class="k">switch</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
<span class="ln">24</span>			<span class="o">...</span>
<span class="ln">25</span>		<span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
<span class="ln">26</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SyncLoop (DELETE, %q): %q&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
<span class="ln">27</span>			<span class="c1">// DELETE is treated as a UPDATE because of graceful deletion.
</span><span class="ln">28</span><span class="c1"></span>            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
<span class="ln">29</span>        <span class="o">...</span><span class="p">.</span>
<span class="ln">30</span>		<span class="p">}</span>
</code></pre></div><p>For pod deletion, because of graceful deletion, it was handled as update evnet. Every pod event will be handled by an object called <a href="https://sourcegraph.com/github.com/kubernetes/kubernetes@v1.14.6/-/blob/pkg/kubelet/kubelet.go#L2081">podWorker</a>. It maintains a podUpdate map and invokes <code>syncPodFn</code> function to sync the latest change to the &ldquo;pod&rdquo;. Please pay attention, this pod is not resource object in kube-apiserver, it is a logical pod object on the host where kubelet was deployed.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">podWorkers</span><span class="p">)</span> <span class="nf">managePodLoop</span><span class="p">(</span><span class="nx">podUpdates</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">UpdatePodOptions</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="kd">var</span> <span class="nx">lastSyncTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="ln"> 3</span>	<span class="k">for</span> <span class="nx">update</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">podUpdates</span> <span class="p">{</span>
<span class="ln"> 4</span>		<span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 5</span>            <span class="nx">podUID</span> <span class="o">:=</span> <span class="nx">update</span><span class="p">.</span><span class="nx">Pod</span><span class="p">.</span><span class="nx">UID</span>
<span class="ln"> 6</span>            <span class="o">...</span>
<span class="ln"> 7</span>			<span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">syncPodFn</span><span class="p">(</span><span class="nx">syncPodOptions</span><span class="p">{</span>
<span class="ln"> 8</span>				<span class="nx">mirrorPod</span><span class="p">:</span>      <span class="nx">update</span><span class="p">.</span><span class="nx">MirrorPod</span><span class="p">,</span>
<span class="ln"> 9</span>				<span class="nx">pod</span><span class="p">:</span>            <span class="nx">update</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span>
<span class="ln">10</span>				<span class="nx">podStatus</span><span class="p">:</span>      <span class="nx">status</span><span class="p">,</span>
<span class="ln">11</span>				<span class="nx">killPodOptions</span><span class="p">:</span> <span class="nx">update</span><span class="p">.</span><span class="nx">KillPodOptions</span><span class="p">,</span>
<span class="ln">12</span>				<span class="nx">updateType</span><span class="p">:</span>     <span class="nx">update</span><span class="p">.</span><span class="nx">UpdateType</span><span class="p">,</span>
<span class="ln">13</span>			<span class="p">})</span>
</code></pre></div><p>So, in the <code>syncPodFn</code> function, the pod is deleted by <code>kubelet.killpod</code> function. In the <code>containerRuntime.KillPod</code>, it kills containers of the pod in parallel.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">(</span><span class="nx">o</span> <span class="nx">syncPodOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="k">if</span> <span class="p">!</span><span class="nx">runnable</span><span class="p">.</span><span class="nx">Admit</span> <span class="o">||</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">apiPodStatus</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodFailed</span> <span class="p">{</span>
<span class="ln"> 3</span>		<span class="kd">var</span> <span class="nx">syncErr</span> <span class="kt">error</span>
<span class="ln"> 4</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nf">killPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">podStatus</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln"> 5</span>            <span class="o">...</span>
<span class="ln"> 6</span>        <span class="p">}</span>
<span class="ln"> 7</span>    <span class="p">}</span>
<span class="ln"> 8</span><span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">killPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">runningPod</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">status</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">PodStatus</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln">11</span>    <span class="o">...</span>
<span class="ln">12</span>	<span class="c1">// Call the container runtime KillPod method which stops all running containers of the pod
</span><span class="ln">13</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">containerRuntime</span><span class="p">.</span><span class="nf">KillPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">14</span>		<span class="k">return</span> <span class="nx">err</span>
<span class="ln">15</span>	<span class="p">}</span>
<span class="ln">16</span>    <span class="o">...</span>
<span class="ln">17</span><span class="p">}</span>
</code></pre></div><p>When containerRuntimeManager kills containers, it calculates the gracePeriod time first based on <code>DeletionGracePeriodSeconds</code> and then tries to stop containers</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="c1">// killContainer kills a container through the following steps:
</span><span class="ln"> 2</span><span class="c1">// * Run the pre-stop lifecycle hooks (if applicable).
</span><span class="ln"> 3</span><span class="c1">// * Stop the container.
</span><span class="ln"> 4</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">killContainer</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">containerID</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">containerName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="o">...</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>	<span class="c1">// From this point , pod and container must be non-nil.
</span><span class="ln"> 8</span><span class="c1"></span>	<span class="nx">gracePeriod</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">minimumGracePeriodInSeconds</span><span class="p">)</span>
<span class="ln"> 9</span>	<span class="k">switch</span> <span class="p">{</span>
<span class="ln">10</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln">11</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span>
<span class="ln">12</span>	<span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
<span class="ln">13</span>		<span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span>    <span class="o">...</span>
<span class="ln">16</span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">StopContainer</span><span class="p">(</span><span class="nx">containerID</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">gracePeriod</span><span class="p">)</span>
<span class="ln">17</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">18</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Container %q termination failed with gracePeriod %d: %v&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">gracePeriod</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">19</span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">20</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Container %q exited normally&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
<span class="ln">21</span>	<span class="p">}</span>
<span class="ln">22</span>
<span class="ln">23</span>	<span class="nx">m</span><span class="p">.</span><span class="nx">containerRefManager</span><span class="p">.</span><span class="nf">ClearRef</span><span class="p">(</span><span class="nx">containerID</span><span class="p">)</span>
<span class="ln">24</span>
<span class="ln">25</span>	<span class="k">return</span> <span class="nx">err</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>Stop container is easy to do. Kubelet just invokes Stop interface of container runtime. In my environment, the container runtime is Docker. <a href="https://docs.docker.com/engine/reference/commandline/stop/">Docker will send the SIGTERM to cotnainer first, after grace period passed, send the SIGKILL to container finally. </a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">RemoteRuntimeService</span><span class="p">)</span> <span class="nf">StopContainer</span><span class="p">(</span><span class="nx">containerID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">timeout</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="ln"> 2</span>	<span class="c1">// Use timeout + default timeout (2 minutes) as timeout to leave extra time
</span><span class="ln"> 3</span><span class="c1"></span>	<span class="c1">// for SIGKILL container and request latency.
</span><span class="ln"> 4</span><span class="c1"></span>	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">+</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="ln"> 5</span>	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nf">getContextWithTimeout</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="ln"> 6</span>	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>	<span class="nx">r</span><span class="p">.</span><span class="nx">errorMapLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
<span class="ln"> 9</span>	<span class="nb">delete</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">lastError</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">)</span>
<span class="ln">10</span>	<span class="nb">delete</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">errorPrinted</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">)</span>
<span class="ln">11</span>	<span class="nx">r</span><span class="p">.</span><span class="nx">errorMapLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="ln">12</span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">runtimeClient</span><span class="p">.</span><span class="nf">StopContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">StopContainerRequest</span><span class="p">{</span>
<span class="ln">13</span>		<span class="nx">ContainerId</span><span class="p">:</span> <span class="nx">containerID</span><span class="p">,</span>
<span class="ln">14</span>		<span class="nx">Timeout</span><span class="p">:</span>     <span class="nx">timeout</span><span class="p">,</span>
<span class="ln">15</span>	<span class="p">})</span>
<span class="ln">16</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">17</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;StopContainer %q from runtime service failed: %v&#34;</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">18</span>		<span class="k">return</span> <span class="nx">err</span>
<span class="ln">19</span>	<span class="p">}</span>
<span class="ln">20</span>
<span class="ln">21</span>	<span class="k">return</span> <span class="kc">nil</span>
<span class="ln">22</span><span class="p">}</span>
</code></pre></div><p>After all containers of the pod are cleaned based on the above process, kubelet sends the deletion request of that pod again. It is done by an object called <a href="https://sourcegraph.com/github.com/kubernetes/kubernetes@633ab1c/-/blob/pkg/kubelet/status/status_manager.go#L541">pod status manager</a>. It is responsible for sync pod status from kubelet to kube-apiserver. The only difference with user&rsquo;s deletion request is: grace period is 0. It means kube-apiserver can delete that pod from etcd storage at once.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="c1">// syncPod syncs the given status with the API server. The caller must not hold the lock.
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">(</span><span class="nx">uid</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">status</span> <span class="nx">versionedPodStatus</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>	<span class="k">if</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nf">needsUpdate</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Status for pod %q is up-to-date; skipping&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">)</span>
<span class="ln"> 5</span>		<span class="k">return</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>    <span class="o">...</span>
<span class="ln"> 8</span>	<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nf">canBeDeleted</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>		<span class="nx">deleteOptions</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{</span>
<span class="ln">10</span>			<span class="nx">GracePeriodSeconds</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int64</span><span class="p">),</span>
<span class="ln">11</span>			<span class="c1">// Use the pod UID as the precondition for deletion to prevent deleting a
</span><span class="ln">12</span><span class="c1"></span>			<span class="c1">// newly created pod with the same name and namespace.
</span><span class="ln">13</span><span class="c1"></span>			<span class="nx">Preconditions</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewUIDPreconditions</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">)),</span>
<span class="ln">14</span>		<span class="p">}</span>
<span class="ln">15</span>		<span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">deleteOptions</span><span class="p">)</span>
<span class="ln">16</span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">17</span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Failed to delete status for pod %q: %v&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
<span class="ln">18</span>			<span class="k">return</span>
<span class="ln">19</span>		<span class="p">}</span>
<span class="ln">20</span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Pod %q fully terminated and removed from etcd&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">))</span>
<span class="ln">21</span>		<span class="nx">m</span><span class="p">.</span><span class="nf">deletePodStatus</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
<span class="ln">22</span>    <span class="p">}</span>
</code></pre></div><p>Now, the second round ended. But the deletion process isn&rsquo;t finished yet. In the next round, the kube-apiserver comes back as the leader.</p>
<h3 id="third-round----from-kube-apiserver-to-etcd">Third Round &ndash; from kube-apiserver to etcd</h3>
<p>The start point of the third round is from <code>Delete</code> method of <code>StandardStorage</code> in kube-apiserver. It is almost the same as the first round. In <code>updateForGracefulDeletionAndFinalizers</code> function, it will check two points</p>
<ol>
<li>If finalizers of resource object are nil</li>
<li>If GracePeriodSeconds is 0</li>
</ol>
<p>Both requirements are satisfied at the same time, and the <code>deleteImmediately</code> will be returned as true. At this time, it will not exit earlier. kube-apiserver deletes the pod from the storage finally.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="ln"> 1</span><span class="c1">// Delete removes the item from storage.
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="ln"> 5</span>    <span class="o">...</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="nx">graceful</span> <span class="o">||</span> <span class="nx">pendingFinalizers</span> <span class="o">||</span> <span class="nx">shouldUpdateFinalizers</span> <span class="p">{</span>
<span class="ln"> 7</span>		<span class="nx">err</span><span class="p">,</span> <span class="nx">ignoreNotFound</span><span class="p">,</span> <span class="nx">deleteImmediately</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">lastExisting</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">updateForGracefulDeletionAndFinalizers</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">preconditions</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="ln"> 8</span>    <span class="p">}</span>
<span class="ln"> 9</span>    
<span class="ln">10</span>    <span class="c1">// first around exits from here
</span><span class="ln">11</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">deleteImmediately</span> <span class="o">||</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">12</span>		<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>    
<span class="ln">15</span>    <span class="o">...</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="c1">// thrid around will delete the pod from storage foever
</span><span class="ln">18</span><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">6</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;going to delete %s from registry: &#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln">19</span>	<span class="nx">out</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewFunc</span><span class="p">()</span>
<span class="ln">20</span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">preconditions</span><span class="p">,</span> <span class="nx">dryrun</span><span class="p">.</span><span class="nf">IsDryRun</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">21</span>		<span class="c1">// Please refer to the place where we set ignoreNotFound for the reason
</span><span class="ln">22</span><span class="c1"></span>		<span class="c1">// why we ignore the NotFound error .
</span><span class="ln">23</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">storage</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">ignoreNotFound</span> <span class="o">&amp;&amp;</span> <span class="nx">lastExisting</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="ln">24</span>			<span class="c1">// The lastExisting object may not be the last state of the object
</span><span class="ln">25</span><span class="c1"></span>			<span class="c1">// before its deletion, but it&#39;s the best approximation.
</span><span class="ln">26</span><span class="c1"></span>			<span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">finalizeDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">lastExisting</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="ln">27</span>			<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">err</span>
<span class="ln">28</span>		<span class="p">}</span>
<span class="ln">29</span>		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">storeerr</span><span class="p">.</span><span class="nf">InterpretDeleteError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">qualifiedResource</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
<span class="ln">30</span>	<span class="p">}</span>
<span class="ln">31</span>	<span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">finalizeDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="ln">32</span>	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">err</span>
</code></pre></div><h2 id="about-finalizers">About Finalizers</h2>
<p>You can see that finalizers of the resource object are also an important factor that can block the deletion process except for graceful time. Actually, finalizers was set when the resource object was created by the controller. When the controller found the DeletionTimestamp of that object wasn&rsquo;t nil, it will process deletion logic based on the finalizers name. Finalizers are just a string slice, which includes the finalizer&rsquo;s name.</p>
<p>In this blog. I will not introduce it too much because it is related to another big topic about Garbage Collection. So I just assume there are no finalizers of finalizers that were removed successfully by default.</p>
<h2 id="which-reasons-can-cause-the-deletion-process-was-stuck">Which reasons can cause the deletion process was stuck</h2>
<p>According to the expected behavior of the graceful deletion process, we can know.</p>
<ol>
<li>If the graceful period is 0 and no finalizers, no one can block the deletion process</li>
<li>If the graceful period isn&rsquo;t 0 or some finalizers left on resource object, both of them may block the deletion process</li>
</ol>
<p>For the finalizers part, there are two possibilities.</p>
<ol>
<li>Native controllers or custom controllers(For Custom Resource) don&rsquo;t process the deletion logic based on finalizers, or it was failed.</li>
<li>Deletion logic of finalizers was finished successfully, when controller removes finalizers, it was failed</li>
</ol>
<p>For the graceful period, the trouble has strong possibilities on kubelet</p>
<ol>
<li>When kubelet invokes container runtime to clean cotnainers, it was stuck. So the podStatus manager still doesn&rsquo;t update GracePeriodSeconds to 0. There are also further reasons, like the volume of pod cannot be unattached or unmounted, or container process was in <code>Uninterruptible</code> state. We should investigate in actual trouble scenarios.</li>
<li>Kubelet cannot connect to kube-apiserver. This trouble may happen before kubelet receive DELETE event of pod, also may happen after kubelet finished cleaning work. The former case means kubelet doesn&rsquo;t have a chance to do a cleaning worker. The behind case mean kubelet cannot sync the result to kube-apiserver.</li>
</ol>
<h2 id="about-force-deletion">About Force Deletion</h2>
<p>As I mentioned at the beginning of this blog, some guys use the workaround like below to delete resource objects.</p>
<ol>
<li>remove finalizers of resource object he(she) wants to delete</li>
<li>using <code>force</code> and <code>grace-period=0</code> argeuments to run kubectl delete command</li>
</ol>
<p>If you still want to use this workaround to fix the &ldquo;deletion process was stuck&rdquo; issue, you must confirm &ldquo;cleaning work&rdquo; about the resource you want to delete has been finished. Otherwise, you will encounter further data inconsistency problems. For example, the volume of the previous pod wasn&rsquo;t unmounted successfully, so your new pod cannot be started.</p>
<p>By the way, even if you used <code>force</code> and <code>grace-period=0</code> argeuments, there is still 2 seconds grace period for that pod. But it&rsquo;s too short.</p>
<h2 id="reference">Reference</h2>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/161072336">https://zhuanlan.zhihu.com/p/161072336</a> (In Chinese)</li>
<li><a href="https://cizixs.com/2017/06/07/kubelet-source-code-analysis-part-2">https://cizixs.com/2017/06/07/kubelet-source-code-analysis-part-2</a> (In Chinese)</li>
<li><a href="https://lwn.net/Articles/288056/">https://lwn.net/Articles/288056/</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination</a></li>
</ol>

  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <h2>Littledriver</h2>
    <div>
      Coder, Learner
    </div>
    <a href = 'https://littledriver.net/about/' class="button mt-1" role="button">Read More</a>
    <h2 class="mt-4">Featured Posts</h2>
    <ul>
    
    </ul>
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      
      <li>
        <a href="https://littledriver.net/post/papaer-node-for-mapreduce/" class="nav-link">Paper Note — MapReduce</a>
      </li>
      <li>
        <a href="https://littledriver.net/post/some-questions-about-layers-of-network-protocol/" class="nav-link">几个和网络分层有关的问题</a>
      </li>
      <li>
        <a href="https://littledriver.net/post/understand-pod-concept/" class="nav-link">The smallest schedulable unit in Kubernetes — Pod</a>
      </li>
      <li>
        <a href="https://littledriver.net/post/understand-container-technology/" class="nav-link">Kubernetes 的基石 — 容器技术</a>
      </li>
    </ul> 
    
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">categories</h2>
      <nav class="tags_nav">
        <a href='https://littledriver.net/categories/kubernetes/' class=" post_tag button button_translucent">
          KUBERNETES
          <span class='button_tally'>3</span>
        </a>
        
        <a href='https://littledriver.net/categories/container/' class=" post_tag button button_translucent">
          CONTAINER
          <span class='button_tally'>2</span>
        </a>
        
        <a href='https://littledriver.net/categories/distributed-system/' class=" post_tag button button_translucent">
          DISTRIBUTED-SYSTEM
          <span class='button_tally'>1</span>
        </a>
        
        <a href='https://littledriver.net/categories/network/' class=" post_tag button button_translucent">
          NETWORK
          <span class='button_tally'>1</span>
        </a>
        
        <a href='https://littledriver.net/categories/troubleshooting/' class=" post_tag button button_translucent">
          TROUBLESHOOTING
          <span class='button_tally'>1</span>
        </a>
        
        
      </nav>
    </div>
    
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">tags</h2>
      <nav class="tags_nav">
        <a href='https://littledriver.net/tags/container/' class=" post_tag button button_translucent">
          CONTAINER
          <span class='button_tally'>2</span>
        </a>
        
        <a href='https://littledriver.net/tags/kubernetes/' class=" post_tag button button_translucent">
          KUBERNETES
          <span class='button_tally'>2</span>
        </a>
        
        <a href='https://littledriver.net/tags/index/' class=" post_tag button button_translucent">
          INDEX
          <span class='button_tally'>1</span>
        </a>
        
        <a href='https://littledriver.net/tags/kuberentes/' class=" post_tag button button_translucent">
          KUBERENTES
          <span class='button_tally'>1</span>
        </a>
        
        <a href='https://littledriver.net/tags/network/' class=" post_tag button button_translucent">
          NETWORK
          <span class='button_tally'>1</span>
        </a>
        
        <a href='https://littledriver.net/tags/paper-note/' class=" post_tag button button_translucent">
          PAPER-NOTE
          <span class='button_tally'>1</span>
        </a>
        
        
      </nav>
    </div>
    
  </section>
</aside>

</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol viewBox="-21 0 512 512" xmlns="http://www.w3.org/2000/svg" id="yank">
    <path d="M410.668 405.332H165.332c-32.363 0-58.664-26.3-58.664-58.664v-288c0-32.363 26.3-58.668 58.664-58.668h181.504c21.059 0 41.687 8.535 56.555 23.445l42.496 42.496c15.125 15.125 23.445 35.223 23.445 56.575v224.152c0 32.363-26.3 58.664-58.664 58.664zM165.332 32c-14.7 0-26.664 11.969-26.664 26.668v288c0 14.7 11.965 26.664 26.664 26.664h245.336c14.7 0 26.664-11.965 26.664-26.664V122.516c0-12.82-4.992-24.871-14.059-33.942l-42.496-42.496C371.84 37.121 359.488 32 346.836 32zm0 0"></path>
    <path d="M314.668 512h-256C26.305 512 0 485.695 0 453.332V112c0-32.363 26.305-58.668 58.668-58.668h10.664c8.832 0 16 7.168 16 16s-7.168 16-16 16H58.668C43.968 85.332 32 97.301 32 112v341.332C32 468.032 43.969 480 58.668 480h256c14.7 0 26.664-11.969 26.664-26.668v-10.664c0-8.832 7.168-16 16-16s16 7.168 16 16v10.664c0 32.363-26.3 58.668-58.664 58.668zM368 181.332H208c-8.832 0-16-7.168-16-16s7.168-16 16-16h160c8.832 0 16 7.168 16 16s-7.168 16-16 16zm0 0"></path>
    <path d="M368 245.332H208c-8.832 0-16-7.168-16-16s7.168-16 16-16h160c8.832 0 16 7.168 16 16s-7.168 16-16 16zm0 64H208c-8.832 0-16-7.168-16-16s7.168-16 16-16h160c8.832 0 16 7.168 16 16s-7.168 16-16 16zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="arrow">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="copy">
    <path d="M366.345 406.069H66.207c-9.751 0-17.655-7.904-17.655-17.655V17.655C48.552 7.904 56.456 0 66.207 0h300.138C376.096 0 384 7.904 384 17.655v370.759c0 9.751-7.904 17.655-17.655 17.655z" fill="#f1f4fb"></path>
    <path d="M384 388.414v-76.992c-.907.322-1.869.494-2.751.882-6.307-6.593-14.733-11.025-24.111-11.964a40.49 40.49 0 0 0-8.448.039v-92.93c0-21.903-17.82-39.723-39.723-39.724a40.5 40.5 0 0 0-4.036.202c-20.012 2.004-35.689 19.916-35.689 40.781v101.773l-21.581 21.581c-15.241 15.241-21.393 36.866-16.456 57.847l3.802 16.16h131.338c9.75 0 17.655-7.905 17.655-17.655z"
      fill="#d5dced"></path>
    <circle cx="128" cy="105.931" r="26.483" fill="#b4e66e"></circle>
    <circle cx="128" cy="203.034" r="26.483" fill="#dae169"></circle>
    <circle cx="128" cy="300.138" r="26.483" fill="#ffdc64"></circle>
    <path d="M331.034 229.517H189.793c-4.879 0-8.828-3.953-8.828-8.828s3.948-8.828 8.828-8.828h141.241c4.879 0 8.828 3.953 8.828 8.828s-3.948 8.828-8.828 8.828z" fill="#7f8499"></path>
    <path d="M295.724 194.207H189.793a8.826 8.826 0 0 1-8.828-8.828 8.826 8.826 0 0 1 8.828-8.828h105.931a8.826 8.826 0 0 1 8.828 8.828 8.826 8.826 0 0 1-8.828 8.828z" fill="#5b5d6e"></path>
    <path d="M331.034 326.621H189.793c-4.879 0-8.828-3.953-8.828-8.828s3.948-8.828 8.828-8.828h141.241c4.879 0 8.828 3.953 8.828 8.828s-3.948 8.828-8.828 8.828z" fill="#7f8499"></path>
    <path d="M295.724 291.31H189.793c-4.879 0-8.828-3.953-8.828-8.828s3.948-8.828 8.828-8.828h105.931c4.879 0 8.828 3.953 8.828 8.828s-3.948 8.828-8.828 8.828z" fill="#5b5d6e"></path>
    <path d="M331.034 132.414H189.793a8.826 8.826 0 0 1-8.828-8.828 8.826 8.826 0 0 1 8.828-8.828h141.241a8.826 8.826 0 0 1 8.828 8.828 8.826 8.826 0 0 1-8.828 8.828z" fill="#7f8499"></path>
    <path d="M295.724 97.103H189.793a8.826 8.826 0 0 1-8.828-8.828 8.826 8.826 0 0 1 8.828-8.828h105.931a8.826 8.826 0 0 1 8.828 8.828 8.825 8.825 0 0 1-8.828 8.828z" fill="#5b5d6e"></path>
    <path d="M443.656 335.563c-13.21-1.323-24.345 9.015-24.345 21.954v-7.569c0-11.544-8.306-22.063-19.794-23.213-13.209-1.323-24.344 9.015-24.344 21.954v-7.569c0-11.544-8.306-22.063-19.794-23.213-13.209-1.323-24.344 9.015-24.344 21.954V207.448c0-12.939-11.135-23.277-24.345-21.954-11.486 1.15-19.793 11.669-19.793 23.213v109.086l-26.752 26.752a44.14 44.14 0 0 0-11.754 41.32l18.47 78.495c6.567 27.913 31.475 47.64 60.15 47.64h74.645c34.127 0 61.793-27.666 61.793-61.793v-91.431c-.001-11.544-8.306-22.063-19.793-23.213z"
      fill="#f0c087"></path>
    <path d="M339.862 361.377a8.829 8.829 0 0 0 8.828-8.828v-34.194c-10.052 2.061-17.655 10.844-17.655 21.506v12.687a8.827 8.827 0 0 0 8.827 8.829zM384 370.205a8.829 8.829 0 0 0 8.828-8.828v-34.194c-10.052 2.061-17.655 10.844-17.655 21.506v12.687a8.827 8.827 0 0 0 8.827 8.829zm44.138 8.827a8.829 8.829 0 0 0 8.828-8.828V336.01c-10.052 2.061-17.655 10.844-17.655 21.506v12.687a8.827 8.827 0 0 0 8.827 8.829zM288.885 464.36l-20.467-86.985a28.482 28.482 0 0 1 7.585-26.663l10.893-10.894v22.113a8.829 8.829 0 0 0 17.656 0V185.933c-10.344 2.173-17.655 11.972-17.655 22.773v109.087l-26.752 26.752a44.14 44.14 0 0 0-11.754 41.32l18.47 78.495c6.567 27.913 31.475 47.64 60.15 47.64h22.026c-28.677 0-53.584-19.727-60.152-47.64z"
      fill="#e6af78"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
</svg>
<footer class = 'footer'>
  <div class = 'footer_inner wrap pale'>
    <img src = 'https://littledriver.net/icons/apple-touch-icon.png' class = 'icon icon_2 transparent'>
    <p>Copyright &copy;&nbsp;<span class = 'year'></span>&nbsp;LITTLEDRIVER&#39;S BLOG. All Rights Reserved</p>
<a class='to_top' href="#documentTop">
  <svg class="icon">
    <use xlink:href="#arrow"></use>
  </svg>
</a>

  </div>
</footer>
    <script src = 'https://littledriver.net/js/bundle.7931a7d4f76c078f1d802a6fb248ded50ab9cdad3afc0715215a9e6aae99cb3e041795cd26bee78992949e322a724772f97789f849656869980be6b0d540eed8.js'></script>
  </body>
</html>
